<!DOCTYPE html><html lang="en"><head><title>Personal site by Severin Fürbringer</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="author" content="Severin Fürbringer"><meta name="description" content="Memos, posts and projects by Severin Fürbringer"><meta name="robots" content="index,follow"><link rel="shortcut icon" href="/public/favicon.ico" type="image/x-icon"><link rel="stylesheet" href="/stylesheets/main.css"><link rel="stylesheet" href="/stylesheets/pure.min.css"></head><body><div class="wrapper"><header><div class="header-inner"><div class="pure-g"><div class="pure-u-1-3"><a href="/"><img src="/public/images/sf.png" alt="Severin Fürbringer Logo" title="Home" class="img-pure"></a></div><div class="pure-u-2-3"><nav><ul><li><a href="/projects" title="Free projects I sometimes work on">Projects</a></li><li><a href="/posts" title="Memos, posts and oder writing">Posts</a></li><li><a href="/about" title="About me">About</a></li><li><a href="/now" title="What I'm currently occupied with">Now</a></li></ul></nav></div></div><div class="pure-g"><div class="pure-u-1"><hr class="header-line"></div></div><div class="pure-g"><div class="pure-u-1"><p class="header-subtitle">Personal site by <span class="header-subtitle-name">Severin Fürbringer</span></p></div></div></div></header><section class="content"><div class="content-inner"><article><h1>Declaring Modules for NixOS</h1><h2>What is Nix and NixOS?</h2><p>Nix is an excellent declarative package manager which really shines as it appears in NixOS. An operating system which let&#39;s you fully declare what your system should look like and builds it according to that. Using its functional dedicated scripting language (DSL) Nix allows for a text based, modular and near infinite amount of possible operating system configurations. Webservers hosting hundreds of vhosts, Tor nodes, desktop workstations, <em>riced</em> i3wm ThinkPad setups, NixOS does not get in the way.
In fact, I&#39;m using NixOS for exactly that. A desktop and laptop configuration all in one. It&#39;s available <a href="https://github.com/fuerbringer/nixfiles">here</a>.</p>
<p><em>Note: This memo does not describe how to write packages / derivations for Nix.</em></p>
<h2>Modularity</h2><p>Imagine you could have the exact same setup across all of your machines with configurable aspects depending on whether the machine is mobile or not. Well, it&#39;s probably not hard to imagine, you just have to do it. But doing so might be rather annoying if done manually, or simply a waste of time. Some might immidiately suggest Ansible, and while that would work, I&#39;d argue it&#39;s not the best option for this usecase. Let us now have a look at how elagantly NixOS solves this problem.</p>
<h3>configuration.nix</h3><p>Each machine has a <code>configuration.nix</code> file. It defines the computers state. It might have something like this in it:</p>
<pre><code>services = {
  xserver = {
    enable = true;
    # &lt;desktop manager configuration maybe?&gt;
    windowManager = {
      i3 = {
        enable = true;
      };
      default = &quot;i3&quot;;
    };
  };

  compton = {
    enable = true;
  };
};</code></pre><p>That Nix configuration gets us halfway to a ready to use i3wm desktop. It could almost be <code>git pull</code>ed to multiple machines and built! But what do you do if you don&#39;t want Compton with fancy effects running on your battery powered laptop? What we&#39;d need is some kind of way to pack the above code into a module, a function if you will, and tell it, as a parameter, whether to be in mobile mode or not.</p>
<h3>Small module example</h3><p>Let us now take a look at a small NixOS module.</p>
<pre><code>{ config, lib, pkgs, ...}:

with lib; 

let
  cfg = config.services.myModule;
in {
  options.services = {
    myModule = {
      isMobile = mkOption {
        default = false;
        type = with types; nullOr bool;
        description = &quot;Whether the computer is a mobile device.&quot;;
      };
    };
  };

  config = {
    services = {
      xserver = {
        enable = true;
        layout = &quot;us&quot;;

        # Use LightDM as display manager
        displayManager.lightdm.enable = true;

        # Enable on mobile for touchpads, etc.
        libinput.enable = cfg.isMobile;

        # Use i3wm with a custom config
        windowManager = {
          i3.enable = true;
          default = &quot;i3&quot;;
        };
      };

      compton = {
        enable = !cfg.isMobile;
        extraOptions = &#39;&#39;
        # Fancy expensive effects here!
        &#39;&#39;;
      };
    };
  };
}</code></pre><p>So what do we have here? Think of it as a function we can import and call in our <code>configuration.nix</code> and define whether we want mobile mode (<code>options.services.myModule.isMobile</code>) to be enabled. Well, it&#39;s exactly that! Assuming the above module is saved as <code>myModule.nix</code> it can be imported into a <code>configuration.nix</code> like so:</p>
<pre><code>{ config, pkgs, ...  }:
{
  imports = [
    ./myModule.nix
  ];

  services.myModule.isMobile = true;

  # Rest of configuration.nix
}</code></pre><p>And that&#39;s it! Another <code>configuration.nix</code> for your desktop computer with <code>isMobile</code> set to <code>false</code> would disable Compton accordingly. As already mentioned, this allows for near infinite flexibility. With a bit more Nix language knowledge you could go on to dynamically generating differing <code>/etc</code> configuration files defining on the module parameters.</p>
<p>If you need a complete example for this use case take a look at my <a href="https://github.com/fuerbringer/nixfiles">nixfiles</a>!</p>
<h2>Further reading</h2><ul>
<li><a href="https://nixos.org/nixos/manual/index.html#sec-writing-modules">NixOS Manual, &quot;Chapter 34. Writing NixOS Modules&quot;</a></li>
<li><a href="https://nixos.org/nixos/nix-pills/basics-of-language.html">Nix Pills, &quot;Chapter 4. The Basics of the Language&quot;</a></li>
</ul></article></div></section><footer><div class="footer-inner"><div class="pure-g"><div class="pure-u-1-3"><p class="footer-left">By <a href="/contact">Severin Fürbringer</a></p></div><div class="pure-u-1-3"><p class="footer-middle"><a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/legalcode" target="_blank"><img alt="Creative Commons License" style="border-width:0" src="/public/images/cc_by_sa.png"></a></p></div><div class="pure-u-1-3"><p class="footer-right"><a href="https://github.com/fuerbringer/fuerbringer.info" target="_blank">Page source</a></p></div></div></div></footer></div></body></html>